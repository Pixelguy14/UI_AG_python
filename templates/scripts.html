<!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <!-- Chart.js Annotation Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0/dist/chartjs-plugin-annotation.min.js"></script>
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>

    <script>
      // --- GLOBAL SCRIPT MANAGER FOR CLEANUP ---
      window.pageScriptRegistry = { cleanup: null };

      // Single listener to clean up old page scripts before swapping
      document.body.addEventListener('htmx:beforeSwap', function(evt) {
          if (window.pageScriptRegistry.cleanup) {
              window.pageScriptRegistry.cleanup();
              window.pageScriptRegistry.cleanup = null; // De-register after running
          }
      });

      document.body.addEventListener('htmx:beforeRequest', function(evt) {
          // Add loading class to the triggering element
          evt.detail.elt.classList.add('htmx-request');
          // Store start time for performance measurement
          evt.detail.xhr.startTime = performance.now();
      });

      document.body.addEventListener('htmx:afterRequest', function(evt) {
          // Remove loading class from the triggering element
          evt.detail.elt.classList.remove('htmx-request');
      });

      document.body.addEventListener('htmx:beforeSwap', function(evt) {
          // Handle sidebar visibility before content swap to prevent flash
          handleSidebarVisibility();
          
          // Add fade-out animation before swapping
          if (evt.detail.target) {
              evt.detail.target.style.opacity = '0';
              evt.detail.target.style.transform = 'translateY(-10px)';
          }
      });

      document.body.addEventListener('htmx:afterSwap', function(evt) {
          // Add fade-in animation after swapping
          if (evt.detail.target) {
              evt.detail.target.style.opacity = '1';
              evt.detail.target.style.transform = 'translateY(0)';
              evt.detail.target.classList.add('fade-in');
          }

          // Calculate and log HTMX load time
          const startTime = evt.detail.xhr.startTime;
          if (startTime) {
              const duration = performance.now() - startTime;
              console.log(`HTMX content loaded and swapped in ${duration.toFixed(2)}ms`);
          }
      });

      // --- GLOBAL TOAST NOTIFICATION HANDLER ---
      function showToast(message, category = 'info') {
          const toastContainer = document.getElementById('toast-container');
          if (!toastContainer) return;

          const toastId = 'toast-' + Date.now();
          const icons = {
              success: 'fa-check-circle',
              danger: 'fa-times-circle',
              warning: 'fa-exclamation-triangle',
              info: 'fa-info-circle'
          };
          const icon = icons[category] || icons.info;

          const toastHtml = `
              <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
                  <div class="toast-header bg-${category} text-white">
                      <i class="fas ${icon} me-2"></i>
                      <strong class="me-auto">Notification</strong>
                      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                  </div>
                  <div class="toast-body">
                      ${message}
                  </div>
              </div>
          `;

          toastContainer.insertAdjacentHTML('beforeend', toastHtml);
          
          const toastElement = document.getElementById(toastId);
          const toast = new bootstrap.Toast(toastElement);

          toastElement.addEventListener('hidden.bs.toast', function () {
              toastElement.remove();
          });

          toast.show();
      }
      // Make it globally accessible
      window.showToast = showToast;

      // --- Sidebar Visibility Handler ---
      function handleSidebarVisibility() {
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        if (sidebar && sidebarToggle) {
          const isHidden = window.location.pathname === '/' || window.location.pathname.endsWith('upload')|| window.location.pathname.endsWith('metadata')|| window.location.pathname.endsWith('groups');
          sidebar.style.display = isHidden ? 'none' : '';
          sidebarToggle.style.display = isHidden ? 'none' : '';
        }
      }

      // --- HTMX ONLOAD: Main UI Initialization and Event Attachment ---
      htmx.onLoad(function(content) {
        // 1. Handle Sidebar Visibility
        handleSidebarVisibility();

        // 2. Re-initialize Bootstrap Components
        // Dropdowns
        document.querySelectorAll('[data-bs-toggle="dropdown"]').forEach(function(toggle) {
            var instance = bootstrap.Dropdown.getInstance(toggle);
            if (instance) {
                instance.dispose();
            }
            new bootstrap.Dropdown(toggle);
        });

        // Collapses (using data-bs-toggle for automatic behavior)
        document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(function(toggle) {
            var targetSelector = toggle.getAttribute('data-bs-target');
            if (!targetSelector) return;
            var targetElement = document.querySelector(targetSelector);
            if (!targetElement) return;
            
            var instance = bootstrap.Collapse.getInstance(targetElement);
            if (instance) {
                instance.dispose();
            }
            new bootstrap.Collapse(targetElement, { toggle: false });
        });

        // Tooltips
        document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(function (tooltipTriggerEl) {
            var instance = bootstrap.Tooltip.getInstance(tooltipTriggerEl);
            if(instance) {
                instance.dispose();
            }
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // 3. Re-attach Custom Event Listeners for Sidebar Buttons and Controls
        // Sidebar Toggle
        const sidebarToggle = document.getElementById('sidebarToggle');
        if (sidebarToggle) {
            sidebarToggle.onclick = function() { // Using onclick to overwrite any previous listener
                const sidebar = document.getElementById('sidebar');
                const toggleIcon = document.getElementById('toggleIcon');
                if (sidebar && toggleIcon) {
                    sidebar.classList.toggle('expanded');
                    toggleIcon.className = sidebar.classList.contains('expanded') ? 'fas fa-chevron-left' : 'fas fa-chevron-right';
                }
            };
        }

        // Threshold Slider
        const thresholdSlider = document.getElementById('thresholdSlider');
        if (thresholdSlider) {
            thresholdSlider.oninput = function() {
                const thresholdValue = document.getElementById('thresholdValue');
                if (thresholdValue) thresholdValue.textContent = this.value;
            };
        }
        document.getElementById('applyThresholdBtn')?.addEventListener('click', () => {
            const threshold = document.getElementById('thresholdSlider').value;
            window.showToast(`Applying threshold of ${threshold}%`, 'info');
        });

        // Replace Zeros Button
        document.getElementById('replaceZerosBtn')?.addEventListener('click', () => {
            window.showToast('Replacing all zeros with NaN values', 'info');
        });

        // Method Description Radios
        const methodDescriptions = {
            'n_imputation': 'Replaces missing values with a small constant value.',
            'half_minimum': 'Replaces missing values with half of the minimum observed value.',
            'mean': 'Replaces missing values with the mean of the observed values.',
            'median': 'Replaces missing values with the median of the observed values.',
            'miss_forest': 'Uses random forest algorithm to predict missing values.',
            'svd': 'Uses Singular Value Decomposition for imputation.',
            'knn': 'Uses K-Nearest Neighbors to impute missing values.',
            'mice_bayesian': 'Multiple Imputation by Chained Equations using Bayesian Ridge regression.',
            'mice_linear': 'Multiple Imputation by Chained Equations using Linear Regression.',
            'tic': 'Normalizes each sample by its total ion current.',
            'mtic': 'Normalizes by the median total ion current across samples.',
            'median': 'Normalizes each feature by its median value.',
            'quantile': 'Transforms features to follow a uniform distribution.',
            'pqn': 'Probabilistic quotient normalization for metabolomics data.',
            'log2': 'Applies logarithm base 2 transformation to reduce skewness.',
            'log10': 'Applies logarithm base 10 transformation to reduce skewness.',
            'sqrt': 'Applies square root transformation to reduce skewness.',
            'cube_root': 'Applies cube root transformation for moderate skewness.',
            'arcsinh': 'Inverse hyperbolic sine transformation, handles zeros and negatives.',
            'glog': 'Generalized logarithm transformation with parameter estimation.',
            'yeo_johnson': 'Power transformation that handles positive and negative values.',
            'standard': 'Standardizes features by removing mean and scaling to unit variance.',
            'minmax': 'Scales features to a fixed range, typically [0,1].',
            'pareto': 'Scales by square root of standard deviation, common in metabolomics.',
            'range': 'Scales by the range (max - min) of the feature.',
            'robust': 'Uses median and interquartile range, robust to outliers.',
            'vast': 'Variable Stability scaling, accounts for coefficient of variation.'
        };
        document.querySelectorAll('input[type="radio"][name$="Method"]').forEach(radio => {
            radio.onchange = function() {
                const methodType = this.name.replace('Method', '');
                const description = document.getElementById(`${methodType}Description`);
                const descriptionText = document.getElementById(`${methodType}DescriptionText`);
                if (description && descriptionText && methodDescriptions[this.value]) {
                    descriptionText.textContent = methodDescriptions[this.value];
                    description.style.display = 'block';
                }
            };
        });

        // Send Buttons
        ['Imputation', 'Normalization', 'Transformation', 'Scaling'].forEach(method => {
            const btn = document.getElementById(`send${method}Btn`);
            if (btn) {
                btn.onclick = function() {
                    const selectedMethod = document.querySelector(`input[name="${method.toLowerCase()}Method"]:checked`);
                    if (selectedMethod) {
                        window.showToast(`Applying ${method}: ${selectedMethod.value}`, 'success');
                    } else {
                        window.showToast(`Please select a ${method.toLowerCase()} method`, 'warning');
                    }
                };
            }
        });
      });
    </script>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <script>
            (function() {
                let messages = {{ messages|tojson }};
                function showFlashedToasts() {
                    if (!messages) return;
                    for (const [category, message] of messages) {
                        window.showToast(message, category);
                    }
                    messages = null;
                }
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', showFlashedToasts, { once: true });
                } else {
                    showFlashedToasts();
                }
                document.body.addEventListener('htmx:afterSwap', showFlashedToasts, { once: true });
            })();
        </script>
    {% endif %}
{% endwith %}
    
    <script>
        window.addEventListener('load', () => {
            const [performanceNavigationTiming] = performance.getEntriesByType("navigation");
            if (performanceNavigationTiming) {
                console.log(`Page fully loaded in: ${performanceNavigationTiming.duration.toFixed(2)}ms`);
            }
        });
    </script>