{% extends "base.html" %}

{% block title %}Analysis - Metabolomic Data Analysis{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
{% endblock %}

{% block content %}
<style>
    #analysis-table thead th {
        position: sticky;
        top: 0;
        z-index: 1;
        text-align: left;
    }
</style>
<div class="container-fluid fade-in">
    <div class="row">
        <!--Sample DataFrame-->
        <div class="col-lg-8">
            <div class="card animated-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-table me-2"></i>
                        Processed Data
                    </h5>
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary dropdown-toggle btn-enhanced pulse-on-hover" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-download me-2"></i>Export Data
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="downloadFile('{{ url_for('dataframes.export_dataframe', format='csv', context='analysis') }}', 'analysis_data.csv')">Export as CSV</a></li>
                            <li><a class="dropdown-item" href="#" onclick="downloadFile('{{ url_for('dataframes.export_dataframe', format='tsv', context='analysis') }}', 'analysis_data.tsv')">Export as TSV</a></li>
                            <li><a class="dropdown-item" href="#" onclick="downloadFile('{{ url_for('dataframes.export_dataframe', format='excel', context='analysis') }}', 'analysis_data.xlsx')">Export as Excel</a></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    <p class="text-muted">Shape: {{ shape[0] }} rows, {{ shape[1] }} columns</p>
                    <div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
                        {{ df_html|safe }}
                    </div>
                    <p class="text-muted mt-3 mb-0">
                        <i class="fas fa-mouse-pointer me-1"></i>
                        Click a column header to display column information
                    </p>
                </div>
            </div>
        </div>

        <!-- Column Information Sidebar -->
        <div class="col-lg-4">
            <!-- Null Distribution Plot -->
            <div class="card animated-card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>
                        Column Analysis
                    </h6>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-light active btn-enhanced pulse-on-hover" id="pie-chart-btn">Pie Chart</button>
                        <button type="button" class="btn btn-light btn-enhanced pulse-on-hover" id="density-plot-btn">Density Plot</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="plot-container" style="height: 300px;">
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-mouse-pointer fa-2x mb-2"></i>
                            <p>Click a column header to view analysis</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Column Statistics -->
            <div class="card animated-card">
                <div class="card-header">
                    <h6 class="mb-0" id="columnInfoTitle">
                        <i class="fas fa-info-circle me-2"></i>
                        Column Information
                    </h6>
                </div>
                <div class="card-body">
                    <div id="columnStats" style="max-height: 40vh; overflow-y: auto;">
                        <div class="text-center text-muted py-3">
                            <p>Click a column header to view statistics</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    (function() {
        let currentColumn = null;
        let currentPlotType = 'pie';

        function downloadFile(url, filename) {
            fetch(url)
                .then(response => response.blob())
                .then(blob => {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                })
                .catch(e => {
                    // console.error('Download failed:', e);
                    window.showToast('Download failed.', 'danger');
                });
        }
        window.downloadFile = downloadFile;

        function updateButtonStates() {
            $('#pie-chart-btn').toggleClass('active', currentPlotType === 'pie');
            $('#density-plot-btn').toggleClass('active', currentPlotType === 'density');
        }

        function loadColumnInfo(columnName, plotType) {
            const plotContainer = $('#plot-container');
            const statsContainer = $('#columnStats');
            
            const statsUrl = `{{ url_for("dataframes.column_info_analysis", column_name="") }}${encodeURIComponent(columnName)}`;
            const plotUrl = plotType === 'pie' 
                ? `{{ url_for("plots.column_pie_plot", column_name="") }}${encodeURIComponent(columnName)}` 
                : `{{ url_for("plots.column_density_plot", column_name="") }}${encodeURIComponent(columnName)}`;

            // Add skeleton loaders
            plotContainer.html('<div class="skeleton" style="height: 300px; width: 100%;"></div>');
            statsContainer.html('<div class="skeleton" style="height: 120px; width: 100%;"></div>');
            $('#columnInfoTitle').html(`<i class="fas fa-info-circle me-2"></i>${columnName}`);

            // Fetch stats
            $.get(statsUrl).done(function(data) {
                if (data.error) {
                    statsContainer.html('');
                    window.showToast(data.error, 'danger');
                } else {
                    statsContainer.html(data.stats);
                }
            }).fail(function() {
                statsContainer.html('');
                window.showToast('Error loading column statistics.', 'danger');
            });

            // Fetch plot
            $.get(plotUrl).done(function(data) {
                if (data.error) {
                    plotContainer.html('<div class="text-center text-muted py-5"><i class="fas fa-exclamation-triangle fa-2x mb-2"></i><p>Could not load plot.</p></div>');
                    window.showToast(data.error, 'danger');
                } else {
                    plotContainer.html(''); // Clear skeleton
                    const plotData = JSON.parse(data.plot);
                    Plotly.newPlot('plot-container', plotData.data, plotData.layout, { responsive: true });
                }
            }).fail(function() {
                plotContainer.html('<div class="text-center text-muted py-5"><i class="fas fa-exclamation-triangle fa-2x mb-2"></i><p>Could not load plot.</p></div>');
                window.showToast('Error loading column plot.', 'danger');
            });
        }

        function init() {
            // Dropdown initialization is now handled globally in base.html

            // Make the headers clickable
            $('#analysis-table th').addClass('clickable-column').on('click', function() {
                currentColumn = $(this).text().trim();
                if (currentColumn) {
                    loadColumnInfo(currentColumn, currentPlotType);
                }
            });

            $('#pie-chart-btn').on('click', function() {
                currentPlotType = 'pie';
                updateButtonStates();
                if (currentColumn) {
                    loadColumnInfo(currentColumn, currentPlotType);
                }
            });

            $('#density-plot-btn').on('click', function() {
                currentPlotType = 'density';
                updateButtonStates();
                if (currentColumn) {
                    loadColumnInfo(currentColumn, currentPlotType);
                }
            });
            updateButtonStates();
        }

        function cleanup() {
            $('#analysis-table th').removeClass('clickable-column').off('click');
            $('#pie-chart-btn').off('click');
            $('#density-plot-btn').off('click');
            const plotDiv = document.getElementById('plot-container');
            if (plotDiv && plotDiv.innerHTML) {
                try {
                    Plotly.purge(plotDiv);
                } catch (e) {
                    // console.error("Error purging plot:", e);
                    window.showToast('Error purging plot','danger')
                }
            }
        }

        // Register with global cleanup registry
        if (window.pageScriptRegistry) {
            window.pageScriptRegistry.cleanup = cleanup;
        }

        // Initialize the page scripts
        init();
    })();
</script>
{% endblock %}
