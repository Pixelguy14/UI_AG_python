{% extends "base.html" %}

{% block title %}Analysis - Metabolomic Data Analysis{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
{% endblock %}

{% block content %}
<style>
    #analysis-table thead th {
        position: sticky;
        top: 0;
        z-index: 1;
        text-align: left;
    }
</style>
<div class="container-fluid">
    <div class="row">
        <!--Sample DataFrame-->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-table me-2"></i>
                        Processed Data
                    </h5>
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-download me-2"></i>Export Data
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="downloadFile('{{ url_for('core.export_dataframe', format='csv', context='analysis') }}', 'analysis_data.csv')">Export as CSV</a></li>
                            <li><a class="dropdown-item" href="#" onclick="downloadFile('{{ url_for('core.export_dataframe', format='tsv', context='analysis') }}', 'analysis_data.tsv')">Export as TSV</a></li>
                            <li><a class="dropdown-item" href="#" onclick="downloadFile('{{ url_for('core.export_dataframe', format='excel', context='analysis') }}', 'analysis_data.xlsx')">Export as Excel</a></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    <p class="text-muted">Shape: {{ shape[0] }} rows, {{ shape[1] }} columns</p>
                    <div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
                        {{ df_html|safe }}
                    </div>
                    <p class="text-muted mt-3 mb-0">
                        <i class="fas fa-mouse-pointer me-1"></i>
                        Click a column header to display column information
                    </p>
                </div>
            </div>
        </div>

        <!-- Column Information Sidebar -->
        <div class="col-lg-4">
            <!-- Null Distribution Plot -->
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>
                        Column Analysis
                    </h6>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-light active" id="pie-chart-btn">Pie Chart</button>
                        <button type="button" class="btn btn-light" id="density-plot-btn">Density Plot</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="plot-container" style="height: 300px;">
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-mouse-pointer fa-2x mb-2"></i>
                            <p>Click a column header to view analysis</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Column Statistics -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0" id="columnInfoTitle">
                        <i class="fas fa-info-circle me-2"></i>
                        Column Information
                    </h6>
                </div>
                <div class="card-body">
                    <div id="columnStats" style="max-height: 40vh; overflow-y: auto;">
                        <div class="text-center text-muted py-3">
                            <p>Click a column header to view statistics</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!--<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>-->
<!--<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>-->
<script>
    (function() {
        let currentColumn = null;
        let currentPlotType = 'pie';

        function downloadFile(url, filename) {
            fetch(url)
                .then(response => response.blob())
                .then(blob => {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                })
                .catch(e => console.error('Download failed:', e));
        }
        window.downloadFile = downloadFile;

        function updateButtonStates() {
            $('#pie-chart-btn').toggleClass('active', currentPlotType === 'pie');
            $('#density-plot-btn').toggleClass('active', currentPlotType === 'density');
        }

        function loadColumnInfo(columnName, plotType) {
            const url = plotType === 'pie' ? `{{ url_for("api.column_info_analysis", column_name="") }}${encodeURIComponent(columnName)}` : `{{ url_for("api.column_density_plot", column_name="") }}${encodeURIComponent(columnName)}`;

            $.get(url)
                .done(function(data) {
                    if (data.error) {
                        $('#plot-container').html(`<div class="alert alert-danger">${data.error}</div>`);
                        return;
                    }

                    $('#columnInfoTitle').html(`<i class="fas fa-info-circle me-2"></i>${columnName}`);
                    $('#columnStats').html(data.stats);

                    const plotData = JSON.parse(plotType === 'pie' ? data.null_plot : data.density_plot);
                    Plotly.newPlot('plot-container', plotData.data, plotData.layout, { responsive: true });
                })
                .fail(function() {
                    $('#plot-container').html('<div class="alert alert-danger">Error loading column information</div>');
                });
        }

        function init() {
            var dropdownElementList = [].slice.call(document.querySelectorAll('.dropdown-toggle'));
            var dropdownList = dropdownElementList.map(function (dropdownToggleEl) {
                return new bootstrap.Dropdown(dropdownToggleEl)
            });

            // Make the headers clickable
            $('#analysis-table th').addClass('clickable-column').on('click', function() {
                currentColumn = $(this).text().trim();
                if (currentColumn) {
                    loadColumnInfo(currentColumn, currentPlotType);
                }
            });

            $('#pie-chart-btn').on('click', function() {
                currentPlotType = 'pie';
                updateButtonStates();
                if (currentColumn) {
                    loadColumnInfo(currentColumn, currentPlotType);
                }
            });

            $('#density-plot-btn').on('click', function() {
                currentPlotType = 'density';
                updateButtonStates();
                if (currentColumn) {
                    loadColumnInfo(currentColumn, currentPlotType);
                }
            });
            updateButtonStates();
        }

        function cleanup() {
            $('#analysis-table th').removeClass('clickable-column').off('click');
            $('#pie-chart-btn').off('click');
            $('#density-plot-btn').off('click');
            const plotDiv = document.getElementById('plot-container');
            if (plotDiv && plotDiv.innerHTML) {
                Plotly.purge(plotDiv);
            }
        }

        if (window.pageScriptRegistry) {
            window.pageScriptRegistry.cleanup = cleanup;
        }
        init();
    })();
</script>
{% endblock %}
