{% extends "base.html" %}

{% block title %}Group Assignments - Metabolomic Data Analysis{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-users me-2"></i>
                        Group Assignments
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Group Definition Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i class="fas fa-users me-2"></i>
                                Define Experimental Groups
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row align-items-center mb-3">
                                <div class="col-md-3">
                                    <label for="nGroups" class="form-label">Number of Groups:</label>
                                    <select class="form-select" id="nGroups" onchange="updateGroupInputs()">
                                        {% for i in range(11) %}
                                        <option value="{{ i }}" {% if i == n_groups %}selected{% endif %}>{{ i }}{% if i == 0 %} (No groups){% endif %}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-9">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Define or modify experimental groups for your sample data.
                                    </small>
                                    <small class="text-muted d-block mt-1">
                                        <i class="fas fa-info-circle me-1"></i>
                                        For automatic grouping, add a regex in parentheses to the group name (e.g., 'Control (C.*)').
                                    </small>
                                </div>
                            </div>
                            <div id="groupInputsContainer"></div>
                        </div>
                    </div>

                    <!-- Column Assignment Table -->
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-striped table-hover table-sm">
                            <thead class="table-light" style="position: sticky; top: 0; z-index: 1;">
                                <tr>
                                    <th>Sample Column</th>
                                    <th>Group Assignment</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for col, info in group_vector.items() %}
                                <tr data-column="{{ col }}">
                                    <td>{{ col }}</td>
                                    <td>
                                        <div class="group-assignment-container" data-column="{{ col }}"></div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-3">
                        <button type="button" class="btn btn-primary" onclick="saveGroupAssignments()">
                            <i class="fas fa-save me-2"></i>Save Group Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Processing Steps</h5>
                </div>
                <div class="card-body">
                    <ul id="processingSteps" class="list-group list-group-flush">
                        {% for step in processing_steps %}
                            <li class="list-group-item"><i class="fas {{ step.icon }} {{ step.color }} me-2"></i>{{ step.message }}</li>
                        {% endfor %}
                        {% if not processing_steps %}
                        <li class="list-group-item text-muted">No processing steps have been applied yet.</li>
                        {% endif %}
                    </ul>
                </div>
            </div>
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>
                        Group Summary
                    </h5>
                </div>
                <div class="card-body">
                    {% for group_name, count in group_summary.items() %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-bold">{{ group_name }}:</span>
                        <span class="badge" style="background-color: #C177F2">{{ count }} columns</span>
                    </div>
                    {% endfor %}
                    
                    {% if not group_summary %}
                    <p class="text-muted">No groups defined yet.</p>
                    {% endif %}
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Group Information
                    </h6>
                </div>
                <div class="card-body">
                    <small class="text-muted">
                        <ul class="mb-0">
                            <li>Groups help organize sample columns for analysis</li>
                            <li>Each sample column can belong to multiple groups</li>
                            <li>Columns with no groups are not assigned to any experimental condition</li>
                            <li>Metadata columns are not assigned to groups</li>
                            <li>Use this for experimental design (e.g., Control + Time1, Treatment + Time1, etc.)</li>
                        </ul>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    (function() {
        let groupAssignments = {{ group_assignments|tojson|safe }};
        let groupNames = {{ group_names|tojson|safe }};
        let groupRegexes = {{ group_regexes|tojson|safe }};

        function init() {
            // Initial setup when page is loaded
            updateGroupInputs();
        }

        function cleanup() {
            // Remove event listeners to prevent memory leaks
            $(".group-checkbox").off("change");
        }

        // Make functions available in the global scope for inline event handlers
        window.updateGroupInputs = function() {
            const nGroups = parseInt($('#nGroups').val());
            const container = $('#groupInputsContainer');
            container.empty();
            
            let newGroupNames = {0: 'Undefined'};

            if (nGroups > 0) {
                const row = $('<div class="row g-3"></div>');
                for (let i = 1; i <= nGroups; i++) {
                    const currentName = groupNames[i] || `Group ${i}`;
                    const currentRegex = groupRegexes[i] || '';
                    const inputValue = currentRegex ? `${currentName} (${currentRegex})` : currentName;
                    newGroupNames[i] = currentName;
                    const col = $(`
                        <div class="col-md-6">
                            <label for="group${i}Name" class="form-label">Group ${i} Name (and optional Regex):</label>
                            <input type="text" class="form-control group-name-input" id="group${i}Name" 
                                   data-group="${i}" value="${inputValue}"
                                   onchange="handleGroupInputChanged(${i})">
                        </div>
                    `);
                    row.append(col);
                }
                container.append(row);
            }
            groupNames = newGroupNames;
            updateAllGroupAssignments();
        }

        window.handleGroupInputChanged = function(groupIndex) {
            const fullInput = $(`#group${groupIndex}Name`).val().trim();
            const openParenIndex = fullInput.indexOf('(');
            const closeParenIndex = fullInput.lastIndexOf(')');
            
            let name = fullInput;
            let regexPattern = '';

            if (openParenIndex !== -1 && closeParenIndex !== -1 && closeParenIndex > openParenIndex) {
                name = fullInput.substring(0, openParenIndex).trim();
                regexPattern = fullInput.substring(openParenIndex + 1, closeParenIndex).trim();
            }

            updateGroupName(groupIndex, name);
            if (regexPattern) { // Only call if regexPattern is not empty
                applyRegexToGroup(groupIndex, regexPattern);
            }
        }

        function updateGroupName(groupIndex, name) {
            groupNames[groupIndex] = name || `Group ${groupIndex}`;
            updateAllGroupAssignments();
        }

        function updateAllGroupAssignments() {
            $('.group-assignment-container').each(function() {
                const column = $(this).data('column');
                updateGroupAssignmentContainer(column);
            });
        }

        function updateGroupAssignmentContainer(column) {
            const container = $(`.group-assignment-container[data-column="${column}"]`);
            const currentSelections = groupAssignments[column] || [];
            container.empty();

            const nGroups = parseInt($('#nGroups').val());
            if (nGroups === 0) {
                container.append('<small class="text-muted">No groups defined</small>');
                groupAssignments[column] = [];
                return;
            }

            const checkboxContainer = $('<div class="d-flex flex-wrap gap-2"></div>');
            for (let i = 1; i <= nGroups; i++) {
                const isChecked = currentSelections.includes(i) || currentSelections.includes(String(i));
                const checkbox = $(`
                    <div class="form-check form-check-inline">
                        <input class="form-check-input group-checkbox" type="checkbox" 
                               id="group_${column}_${i}" data-column="${column}" data-group="${i}"
                               ${isChecked ? 'checked' : ''}>
                        <label class="form-check-label" for="group_${column}_${i}">
                            ${i} - ${groupNames[i] || 'Unnamed'}
                        </label>
                    </div>
                `);
                checkboxContainer.append(checkbox);
            }
            container.append(checkboxContainer);

            container.find('.group-checkbox').on('change', function() {
                updateGroupAssignment(column);
            });
        }

        function updateGroupAssignment(column) {
            const selectedGroups = [];
            $(`.group-checkbox[data-column="${column}"]:checked`).each(function() {
                selectedGroups.push(parseInt($(this).data('group')));
            });
            groupAssignments[column] = selectedGroups;
        }

        window.saveGroupAssignments = function() {
            const nGroups = parseInt($('#nGroups').val());
            for (let i = 1; i <= nGroups; i++) {
                if (!groupNames[i]) {
                    alert(`Please provide a name for Group ${i}`);
                    return;
                }
            }

            const data = {
                groupAssignments: groupAssignments,
                groupNames: groupNames,
                nGroups: nGroups,
                groupRegexes: groupRegexes
            };

            $.ajax({
                url: '{{ url_for("analysis.update_groups") }}',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    if (response.success) {
                        alert(response.message);
                        window.location.reload();
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function() {
                    alert('An unexpected error occurred.');
                }
            });
        }

        function applyRegexToGroup(groupId, regexPattern) {
            if (!regexPattern) {
                return; // Do nothing if regex is empty
            }

            $.ajax({
                url: '{{ url_for("api.apply_regex_grouping") }}',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    groupId: groupId,
                    regexPattern: regexPattern
                }),
                success: function(response) {
                    if (response.success) {
                        groupAssignments = response.groupAssignments; // Update local groupAssignments
                        updateAllGroupAssignments(); // Re-render checkboxes
                    } else {
                        alert('Error applying regex: ' + response.message);
                    }
                },
                error: function() {
                    alert('An error occurred while applying regex.');
                }
            });
        }

        // Register cleanup function
        if (window.pageScriptRegistry) {
            window.pageScriptRegistry.cleanup = cleanup;
        }
        
        // Self-initialize
        init();
    })();
</script>
{% endblock %}