{% extends "base.html" %}

{% block title %}Metadata - Metabolomic Data Analysis{% endblock %}

{% block content %}
<div class="container-fluid fade-in">
    <div class="row justify-content-center">
        <div class="col-lg-12">
            <div class="card animated-card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-tags me-2"></i>
                        Assign Column Types and Groups
                    </h4>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-4">
                        First define your experimental groups, then assign each column as either metadata, sample data, or mark for removal. 
                        Columns left as "undefined" will default to sample data. Sample columns can be assigned to multiple experimental groups.
                    </p>
                    
                    <!-- Group Definition Section -->
                    <div class="mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-users me-2"></i>
                                Define Experimental Groups
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row align-items-center mb-3">
                                <div class="col-md-3">
                                    <label for="nGroups" class="form-label">Number of Groups:</label>
                                    <select class="form-select" id="nGroups" onchange="updateGroupInputs()">
                                        <option value="0">0 (No groups)</option>
                                        <option value="1">1</option>
                                        <option value="2" selected>2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                        <option value="6">6</option>
                                        <option value="7">7</option>
                                        <option value="8">8</option>
                                    </select>
                                </div>
                                <div class="col-md-9">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Define experimental groups for your sample data (e.g., control vs treatment, healthy vs diseased). 
                                        Columns can belong to multiple groups.
                                    </small>
                                    <small class="text-muted d-block mt-1">
                                        <i class="fas fa-info-circle me-1"></i>
                                        For advanced grouping, such as using regular expressions, please use the dedicated 'Groups' page after saving your assignments here.
                                    </small>
                                </div>
                            </div>
                            
                            <div id="groupInputsContainer">
                                <!-- Group name inputs will be dynamically generated here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Column Assignment Table -->
                    <div class="table-responsive">
                        <table class="table table-striped" id="metadataTable">
                            <thead>
                                <tr>
                                    <th>Column Header</th>
                                    <th>Type Assignment</th>
                                    <th>Group Assignment</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for column in columns %}
                                <tr data-column="{{ column }}">
                                    <td>{{ column }}</td>
                                    <td>
                                        <select class="form-select assignment-select" data-column="{{ column }}" onchange="updateGroupSelect('{{ column }}')">
                                            <option value="undefined" 
                                                {% if column not in existing_metadata and column not in existing_sample %}selected{% endif %}>
                                                Undefined
                                            </option>
                                            <option value="metadata" 
                                                {% if column in existing_metadata %}selected{% endif %}>
                                                Metadata
                                            </option>
                                            <option value="sample" 
                                                {% if column in existing_sample %}selected{% endif %}>
                                                Sample
                                            </option>
                                        </select>
                                    </td>
                                    <td>
                                        <div class="group-assignment-container" data-column="{{ column }}">
                                            <!-- Multi-select checkboxes will be generated here -->
                                        </div>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-danger remove-column" data-column="{{ column }}">
                                            <i class="fas fa-times"></i> Remove
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note:</strong> 
                        <ul class="mb-0 mt-2">
                            <li>Columns marked as "undefined" will be treated as sample data</li>
                            <li>Metadata columns cannot be assigned to experimental groups</li>
                            <li>Sample columns can belong to multiple groups simultaneously</li>
                            <li>Unselected groups mean the column doesn't belong to any specific group</li>
                            <li>Removed columns will be excluded from further analysis</li>
                        </ul>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-secondary btn-enhanced pulse-on-hover" onclick="resetAssignments()">
                            <i class="fas fa-undo me-2"></i>Reset
                        </button>
                        <button type="button" class="btn btn-primary btn-enhanced pulse-on-hover" onclick="saveAssignments()">
                            <i class="fas fa-save me-2"></i>Save Assignments
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    (function() {
        let assignments = {};
        let groupAssignments = {}; // Will store arrays of group IDs for each column
        let groupNames = {0: 'Undefined'};
        let groupRegexes = {{ group_regexes|tojson|safe }};

        function handleRemoveClick(event) {
            event.preventDefault();
            const button = $(this);
            const column = button.data('column');
            assignments[column] = 'removed';
            const row = button.closest('tr');

            const tempElement = $('<div class="table-danger"></div>').css({ position: 'absolute', visibility: 'hidden' }).appendTo('body');
            const dangerColor = tempElement.css('background-color');
            tempElement.remove();

            row.children('td').each(function() { this.style.setProperty('background-color', dangerColor, 'important'); });
            row.find('select, input').prop('disabled', true);

            button.html('<i class="fas fa-undo"></i> Restore').removeClass('btn-danger').addClass('btn-success');
            button.off('click', handleRemoveClick).on('click', handleRestoreClick);
        }

        function handleRestoreClick(event) {
            event.preventDefault();
            const button = $(this);
            const column = button.data('column');
            assignments[column] = 'undefined';
            const restoreRow = button.closest('tr');

            restoreRow.children('td').css('background-color', '');
            restoreRow.find('select, input').prop('disabled', false);
            restoreRow.find('.assignment-select').val('undefined');
            
            button.html('<i class="fas fa-times"></i> Remove').removeClass('btn-success').addClass('btn-danger');
            
            window.updateGroupSelect(column);

            button.off('click', handleRestoreClick).on('click', handleRemoveClick);
        }

        function init() {
            // Initialize assignments
            $('.assignment-select').each(function() {
                const column = $(this).data('column');
                assignments[column] = $(this).val();
            });
            
            // Initialize group assignments
            $('.assignment-select').each(function() {
                const column = $(this).data('column');
                groupAssignments[column] = [];
            });
            
            // Handle assignment changes
            $('.assignment-select').on('change', function() {
                const column = $(this).data('column');
                assignments[column] = $(this).val();
            });
            
            // Handle column removal
            $('.remove-column').on('click', handleRemoveClick);
            
            // Initialize group inputs
            window.updateGroupInputs();
        }

        function cleanup() {
            $('.assignment-select').off('change');
            $('.remove-column').off('click', handleRemoveClick).off('click', handleRestoreClick);
            $('.group-checkbox').off('change');
        }

        window.updateGroupInputs = function() {
            const nGroups = parseInt($('#nGroups').val());
            const container = $('#groupInputsContainer');
            container.empty();
            groupNames = {0: 'Undefined'};
            
            if (nGroups > 0) {
                const row = $('<div class="row g-3"></div>');
                for (let i = 1; i <= nGroups; i++) {
                    const currentName = groupNames[i] || `Group ${i}`;
                    const col = $(`
                        <div class="col-md-6">
                            <label for="group${i}Name" class="form-label">Group ${i} Name:</label>
                            <input type="text" class="form-control group-name-input" id="group${i}Name" 
                                   data-group="${i}" placeholder="e.g., Control" value="${currentName}"
                                   onchange="handleGroupInputChanged(${i})">
                        </div>
                    `);
                    row.append(col);
                    groupNames[i] = currentName;
                }
                container.append(row);
            }
            updateAllGroupAssignments();
        }
        
        window.handleGroupInputChanged = function(groupIndex) {
            const name = $(`#group${groupIndex}Name`).val().trim();
            updateGroupName(groupIndex, name);
        }

        function updateGroupName(groupIndex, name) {
            groupNames[groupIndex] = name || `Group ${groupIndex}`;
            updateAllGroupAssignments();
        }
        
        function updateAllGroupAssignments() {
            $('.group-assignment-container').each(function() {
                const column = $(this).data('column');
                updateGroupAssignmentContainer(column);
            });
        }
        
        function updateGroupAssignmentContainer(column) {
            const container = $(`.group-assignment-container[data-column="${column}"]`);
            const isMetadata = $(`.assignment-select[data-column="${column}"]`).val() === 'metadata';
            const isRemoved = assignments[column] === 'removed';
            const currentSelections = groupAssignments[column] || [];
            container.empty();
            
            if (isMetadata || isRemoved) {
                container.append('<small class="text-muted">N/A for metadata</small>');
                groupAssignments[column] = [];
                return;
            }
            
            const nGroups = parseInt($('#nGroups').val());
            if (nGroups === 0) {
                container.append('<small class="text-muted">No groups defined</small>');
                groupAssignments[column] = [];
                return;
            }
            
            const checkboxContainer = $('<div class="d-flex flex-wrap gap-2"></div>');
            for (let i = 1; i <= nGroups; i++) {
                const isChecked = currentSelections.includes(i);
                const checkbox = $(`
                    <div class="form-check form-check-inline">
                        <input class="form-check-input group-checkbox" type="checkbox" 
                               id="group_${column}_${i}" data-column="${column}" data-group="${i}"
                               ${isChecked ? 'checked' : ''}>
                        <label class="form-check-label" for="group_${column}_${i}">${i} - ${groupNames[i]}</label>
                    </div>
                `);
                checkboxContainer.append(checkbox);
            }
            container.append(checkboxContainer);
            container.find('.group-checkbox').on('change', function() { updateGroupAssignment(column); });
        }
        
        function updateGroupAssignment(column) {
            const selectedGroups = [];
            $(`.group-checkbox[data-column="${column}"]:checked`).each(function() {
                selectedGroups.push(parseInt($(this).data('group')));
            });
            groupAssignments[column] = selectedGroups;
        }
        
        window.updateGroupSelect = function(column) {
            updateGroupAssignmentContainer(column);
        }
        
        window.resetAssignments = function() {
            if (confirm('Are you sure you want to reset all assignments?')) {
                $('.assignment-select').val('undefined').prop('disabled', false);
                $('tr').children('td').css('background-color', '');
                $('.remove-column').html('<i class="fas fa-times"></i> Remove').removeClass('btn-success').addClass('btn-danger');
                
                $('.assignment-select').each(function() {
                    const column = $(this).data('column');
                    assignments[column] = 'undefined';
                    groupAssignments[column] = [];
                });
                
                $('.remove-column').off('click').on('click', handleRemoveClick);
                
                $('#nGroups').val(2);
                updateGroupInputs();
            }
        }
        
        window.saveAssignments = function() {
            const nGroups = parseInt($('#nGroups').val());
            for (let i = 1; i <= nGroups; i++) {
                if (!$(`#group${i}Name`).val().trim()) {
                    window.showToast(`Please provide a name for Group ${i}`, 'warning');
                    $(`#group${i}Name`).focus();
                    return;
                }
            }
            
            $.ajax({
                url: '/metadata',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ assignments, groupAssignments, groupNames, nGroups, groupRegexes }),
                success: function(response) {
                    if (response.success) {
                        window.showToast('Assignments and groups saved successfully!', 'success');
                        setTimeout(() => {
                            /*htmx.ajax('GET', '/summary', {
                                target: 'body',
                                swap: 'outerHTML',
                                pushUrl: true
                            });*/
                            window.location.href = '/summary';
                        }, 50);
                    } else {
                        window.showToast('Error saving assignments: ' + response.message, 'danger');
                    }
                },
                error: function() { window.showToast('Error saving assignments. Please try again.', 'danger'); }
            });
        }

        if (window.pageScriptRegistry) { window.pageScriptRegistry.cleanup = cleanup; }
        init();
    })();
</script>
{% endblock %}