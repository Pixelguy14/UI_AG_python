{% extends "base.html" %}

{% block title %}Summary - Metabolomic Data Analysis{% endblock %}

{% block content %}
<div class="container-fluid fade-in" id="summary-content">
    <div class="row">
        <!-- General Statistics -->
        <div class="col-lg-12">
            <div class="card animated-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        General Dataset Statistics
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        {{ general_stats|safe }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <!-- Plots -->
        <div class="col-lg-12">
            <div class="row">
                <!-- Mean Intensity (if available) -->
                {% if plots.mean_intensity %}
                <div class="col-lg-6 mb-4">
                    <div class="plot-container card animated-card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            Mean Intensity
                            <button class="btn btn-secondary btn-sm btn-enhanced pulse-on-hover" onclick="exportPlotAsSVG_RCT('meanIntensityPlot', 'mean_intensity_plot')">
                                <i class="fas fa-download me-2"></i>Export as SVG
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="meanIntensityPlot"></div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Correlation Matrix (if available) -->
                {% if plots.correlation %}
                <div class="col-lg-6 mb-4">
                    <div class="plot-container card animated-card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            Correlation Matrix (Pearson corr.)
                            <button class="btn btn-secondary btn-sm btn-enhanced pulse-on-hover" onclick="exportPlotAsSVG_SQR('correlationPlot', 'correlation_matrix')">
                                <i class="fas fa-download me-2"></i>Export as SVG
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="correlationPlot"></div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Missing Values Heatmap -->
                <div class="col-lg-6 mb-4">
                    <div class="plot-container card animated-card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            Missing Values Distribution
                            <button class="btn btn-secondary btn-sm btn-enhanced pulse-on-hover" onclick="exportPlotAsSVG_RCT('missingHeatmapPlot', 'missing_values_heatmap')">
                                <i class="fas fa-download me-2"></i>Export as SVG
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="missingHeatmapPlot"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Distribution Plot -->
                {% if plots.all_columns_density %}
                <div class="col-lg-6 mb-4">
                    <div class="plot-container card animated-card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            Distribution Plot
                            <div>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-light active btn-enhanced pulse-on-hover" id="dist-select-all">Select All</button>
                                    <button type="button" class="btn btn-light btn-enhanced pulse-on-hover" id="dist-unselect-all">Unselect All</button>
                                </div>
                                <button class="btn btn-secondary btn-sm btn-enhanced pulse-on-hover" onclick="exportPlotAsSVG_RCT('allColumnsDensityPlot', 'distribution_plot')">
                                    <i class="fas fa-download me-2"></i>Export as SVG
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="allColumnsDensityPlot"></div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <!-- Boxplot Distribution -->
    {% if plots.boxplot_distribution %}
    <div class="row mt-4">
        <div class="col-lg-12 mb-4">
            <div class="plot-container card animated-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    General Distribution Plot
                    <div>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-light active btn-enhanced pulse-on-hover" id="boxplot-btn"
                                    hx-get="{{ url_for('api.get_distribution_plot', plot_type='boxplot', context='after') }}"
                                    hx-swap="none"
                                    hx-on:htmx:after-request="handleDistributionPlotResponse(event, 'boxplot')">
                                BoxPlot
                            </button>
                            <button type="button" class="btn btn-light btn-enhanced pulse-on-hover" id="violinplot-btn"
                                    hx-get="{{ url_for('api.get_distribution_plot', plot_type='violinplot', context='after') }}"
                                    hx-swap="none"
                                    hx-on:htmx:after-request="handleDistributionPlotResponse(event, 'violinplot')">
                                ViolinPlot
                            </button>
                        </div>
                        <button class="btn btn-secondary btn-sm btn-enhanced pulse-on-hover" onclick="exportPlotAsSVG_RCT_2('boxplotDistributionPlot', 'distribution_plot')">
                            <i class="fas fa-download me-2"></i>Export as SVG
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="boxplotDistributionPlot" style="min-height: 400px;"></div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // This function must be in the global scope for hx-on to find it.
    function handleDistributionPlotResponse(evt, plotType) {
        const plotDiv = document.getElementById('boxplotDistributionPlot');
        
        // Add a skeleton loader while waiting for the plot
        if (plotDiv) {
            plotDiv.innerHTML = '<div class="skeleton" style="min-height: 400px; width: 100%;"></div>';
        }

        if (evt.detail.successful) {
            try {
                const data = JSON.parse(evt.detail.xhr.responseText);
                if (data.error) {
                    plotDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                    return;
                }
                const plotData = JSON.parse(data.plot);
                // Use a slight delay to allow the skeleton to be visible and improve perceived performance
                setTimeout(() => {
                    Plotly.newPlot(plotDiv, plotData.data, plotData.layout, { responsive: true });
                }, 50);
            } catch (e) {
                plotDiv.innerHTML = '<div class="alert alert-danger">Failed to parse plot data.</div>';
                // console.error("Error parsing plot JSON:", e);
                window.showToast('Error parsing JSON plot','danger')
            }
        } else {
            plotDiv.innerHTML = '<div class="alert alert-danger">Error loading plot data.</div>';
        }

        // Update button states using vanilla JS to avoid jQuery dependency here
        document.getElementById('boxplot-btn').classList.toggle('active', plotType === 'boxplot');
        document.getElementById('violinplot-btn').classList.toggle('active', plotType === 'violinplot');
    }

    (function() {
        // Use an IIFE to scope this page's logic.
        var summaryResizeHandlers = [];

        function init() {
            function loadScript(src, callback) {
                const existingScript = document.querySelector(`script[src="${src}"]`);
                if (existingScript && existingScript.dataset.loaded === 'true') { if (callback) callback(); return; }
                if (existingScript) { existingScript.addEventListener('load', () => { if (callback) callback(); }); return; }
                const script = document.createElement('script');
                script.src = src;
                script.dataset.loaded = 'false';
                script.onload = () => { script.dataset.loaded = 'true'; if (callback) callback(); };
                document.head.appendChild(script);
            }

            function initPageScripts() {
                summaryResizeHandlers = []; // Clear handlers on init

                function createPlot(id, plotData) {
                    const plotDiv = document.getElementById(id);
                    if (plotDiv && plotData) {
                        try {
                            Plotly.newPlot(plotDiv, plotData.data, plotData.layout, { responsive: true });
                            const handler = () => {
                                if (document.body.contains(plotDiv)) {
                                    Plotly.Plots.resize(plotDiv);
                                }
                            };
                            window.addEventListener('resize', handler);
                            summaryResizeHandlers.push({ id: id, handler: handler });
                        } catch (e) {
                            // console.error(`Error rendering plot ${id}:`, e);
                            window.showToast(`Error rendering plot ${id}:`,'danger')
                        }
                    }
                }

                createPlot('allColumnsDensityPlot', {{ plots.all_columns_density|default('null')|safe }});
                createPlot('meanIntensityPlot', {{ plots.mean_intensity|default('null')|safe }});
                createPlot('correlationPlot', {{ plots.correlation|default('null')|safe }});
                createPlot('missingHeatmapPlot', {{ plots.missing_heatmap|default('null')|safe }});
                createPlot('boxplotDistributionPlot', {{ plots.boxplot_distribution|default('null')|safe }});

                // Boxplot/violinplot buttons are now handled by HTMX and handleDistributionPlotResponse.
                // The old jQuery click handlers have been removed.

                $('#dist-select-all').on('click', function() {
                    const plotDiv = document.getElementById('allColumnsDensityPlot');
                    if (plotDiv && plotDiv.data) {
                        Plotly.restyle(plotDiv, { visible: true });
                    }
                    $(this).addClass('active');
                    $('#dist-unselect-all').removeClass('active');
                });

                $('#dist-unselect-all').on('click', function() {
                    const plotDiv = document.getElementById('allColumnsDensityPlot');
                    if (plotDiv && plotDiv.data) {
                        Plotly.restyle(plotDiv, { visible: 'legendonly' });
                    }
                    $(this).addClass('active');
                    $('#dist-select-all').removeClass('active');
                });
            }

            loadScript("{{ url_for('static', filename='js/export.js') }}", function() {
                setTimeout(initPageScripts, 50);
            });
        }

        function cleanup() {
            const plotIds = [
                'meanIntensityPlot', 
                'correlationPlot', 
                'missingHeatmapPlot', 
                'allColumnsDensityPlot', 
                'boxplotDistributionPlot'
            ];
            plotIds.forEach(id => {
                const plotDiv = document.getElementById(id);
                if (plotDiv) {
                    Plotly.purge(plotDiv);
                }
            });

            if (summaryResizeHandlers) {
                summaryResizeHandlers.forEach(({ handler }) => {
                    window.removeEventListener('resize', handler);
                });
            }
            summaryResizeHandlers = [];
            // Remove only the handlers that were set in this script's IIFE
            $('#dist-select-all').off('click');
            $('#dist-unselect-all').off('click');
        }

        // Register the cleanup function
        window.pageScriptRegistry.cleanup = cleanup;

        // Self-initialize
        init();
    })();
</script>
{% endblock %}