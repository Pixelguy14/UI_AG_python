{% extends "base.html" %}

{% block title %}Summary - Metabolomic Data Analysis{% endblock %}

{% block content %}
<div class="container-fluid fade-in" id="summary-content">
    <div class="row">
        <!-- General Statistics -->
        <div class="col-lg-12">
            <div class="card animated-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        General Dataset Statistics
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        {{ general_stats|safe }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <!-- Plots -->
        <div class="col-lg-12">
            <div class="row">
                <!-- Mean Intensity -->
                <div class="col-lg-6 mb-4">
                    <div class="plot-container card animated-card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            Mean Intensity
                            <button class="btn btn-secondary btn-sm btn-enhanced pulse-on-hover" onclick="exportPlotAsSVG_RCT('meanIntensityPlot', 'mean_intensity_plot')">
                                <i class="fas fa-download me-2"></i>Export as SVG
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="meanIntensityPlot" class="plot-loading">
                                <div class="skeleton" style="min-height: 400px; width: 100%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Correlation Matrix -->
                <div class="col-lg-6 mb-4">
                    <div class="plot-container card animated-card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            Correlation Matrix (Pearson corr.)
                            <button class="btn btn-secondary btn-sm btn-enhanced pulse-on-hover" onclick="exportPlotAsSVG_SQR('correlationPlot', 'correlation_matrix')">
                                <i class="fas fa-download me-2"></i>Export as SVG
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="correlationPlot" class="plot-loading">
                                <div class="skeleton" style="min-height: 400px; width: 100%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Missing Values Heatmap -->
                <div class="col-lg-6 mb-4">
                    <div class="plot-container card animated-card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            Missing Values Distribution
                            <button class="btn btn-secondary btn-sm btn-enhanced pulse-on-hover" onclick="exportPlotAsSVG_RCT('missingHeatmapPlot', 'missing_values_heatmap')">
                                <i class="fas fa-download me-2"></i>Export as SVG
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="missingHeatmapPlot" class="plot-loading">
                                <div class="skeleton" style="min-height: 400px; width: 100%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Distribution Plot -->
                <div class="col-lg-6 mb-4">
                    <div class="plot-container card animated-card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            Distribution Plot
                            <div>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-light active btn-enhanced pulse-on-hover" id="dist-select-all">Select All</button>
                                    <button type="button" class="btn btn-light btn-enhanced pulse-on-hover" id="dist-unselect-all">Unselect All</button>
                                </div>
                                <button class="btn btn-secondary btn-sm btn-enhanced pulse-on-hover" onclick="exportPlotAsSVG_RCT('allColumnsDensityPlot', 'distribution_plot')">
                                    <i class="fas fa-download me-2"></i>Export as SVG
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="allColumnsDensityPlot" class="plot-loading">
                                <div class="skeleton" style="min-height: 400px; width: 100%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Boxplot Distribution -->
    <div class="row mt-4">
        <div class="col-lg-12 mb-4">
            <div class="plot-container card animated-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    General Distribution Plot
                    <div>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-light active btn-enhanced pulse-on-hover" id="boxplot-btn"
                                    onclick="loadDistributionPlot('boxplot')">
                                BoxPlot
                            </button>
                            <button type="button" class="btn btn-light btn-enhanced pulse-on-hover" id="violinplot-btn"
                                    onclick="loadDistributionPlot('violinplot')">
                                ViolinPlot
                            </button>
                        </div>
                        <button class="btn btn-secondary btn-sm btn-enhanced pulse-on-hover" onclick="exportPlotAsSVG_RCT_2('boxplotDistributionPlot', 'distribution_plot')">
                            <i class="fas fa-download me-2"></i>Export as SVG
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="boxplotDistributionPlot" class="plot-loading">
                        <div class="skeleton" style="min-height: 400px; width: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Function to load distribution plot
    function loadDistributionPlot(plotType) {
        const plotDiv = document.getElementById('boxplotDistributionPlot');
        const context = 'after'; // or determine context as needed
        
        plotDiv.innerHTML = '<div class="skeleton" style="min-height: 400px; width: 100%;"></div>';
        
        fetch(`{{ url_for('plots.get_distribution_plot', plot_type='PLACEHOLDER', context='after') }}`.replace('PLACEHOLDER', plotType))
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    plotDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                    return;
                }
                const plotData = JSON.parse(data.plot);
                Plotly.newPlot(plotDiv, plotData.data, plotData.layout, { responsive: true });
                plotDiv.classList.remove('plot-loading'); // Remove loading class
                
                // Update button states
                document.getElementById('boxplot-btn').classList.toggle('active', plotType === 'boxplot');
                document.getElementById('violinplot-btn').classList.toggle('active', plotType === 'violinplot');
            })
            .catch(error => {
                plotDiv.innerHTML = '<div class="alert alert-danger">Error loading plot data.</div>';
                console.error("Error loading distribution plot:", error);
            });
    }

    // Function to load a plot via AJAX
    function loadPlot(plotId, endpoint) {
        const plotDiv = document.getElementById(plotId);
        if (!plotDiv) return;
        
        fetch(endpoint)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    plotDiv.innerHTML = `<div class="alert alert-warning">${data.error}</div>`;
                    return;
                }
                if (data.plot) {
                    const plotData = JSON.parse(data.plot);
                    Plotly.newPlot(plotDiv, plotData.data, plotData.layout, { responsive: true });
                    plotDiv.classList.remove('plot-loading'); // Remove loading class
                    
                    // Add resize handler
                    const handler = () => Plotly.Plots.resize(plotDiv);
                    window.addEventListener('resize', handler);
                    if (window.summaryResizeHandlers) {
                        window.summaryResizeHandlers.push({ id: plotId, handler: handler });
                    }
                }
            })
            .catch(error => {
                plotDiv.innerHTML = '<div class="alert alert-danger">Failed to load plot.</div>';
                console.error(`Error loading plot ${plotId}:`, error);
            });
    }

    (function() {
        window.summaryResizeHandlers = [];

        function init() {
            function loadScript(src, callback) {
                const existingScript = document.querySelector(`script[src="${src}"]`);
                if (existingScript && existingScript.dataset.loaded === 'true') { if (callback) callback(); return; }
                if (existingScript) { existingScript.addEventListener('load', () => { if (callback) callback(); }); return; }
                const script = document.createElement('script');
                script.src = src;
                script.dataset.loaded = 'false';
                script.onload = () => { script.dataset.loaded = 'true'; if (callback) callback(); };
                document.head.appendChild(script);
            }

            function initPageScripts() {
                // Load all plots asynchronously
                loadPlot('meanIntensityPlot', "{{ url_for('plots.mean_intensity') }}");
                loadPlot('correlationPlot', "{{ url_for('plots.correlation_matrix') }}");
                loadPlot('missingHeatmapPlot', "{{ url_for('plots.missing_heatmap') }}");
                loadPlot('allColumnsDensityPlot', "{{ url_for('plots.all_columns_density') }}");
                
                // Load initial distribution plot
                loadDistributionPlot('boxplot');

                // Set up distribution plot buttons
                $('#dist-select-all').on('click', function() {
                    const plotDiv = document.getElementById('allColumnsDensityPlot');
                    if (plotDiv && plotDiv.data) {
                        Plotly.restyle(plotDiv, { visible: true });
                    }
                    $(this).addClass('active');
                    $('#dist-unselect-all').removeClass('active');
                });

                $('#dist-unselect-all').on('click', function() {
                    const plotDiv = document.getElementById('allColumnsDensityPlot');
                    if (plotDiv && plotDiv.data) {
                        Plotly.restyle(plotDiv, { visible: 'legendonly' });
                    }
                    $(this).addClass('active');
                    $('#dist-select-all').removeClass('active');
                });
            }

            loadScript("{{ url_for('static', filename='js/export.js') }}", function() {
                setTimeout(initPageScripts, 50);
            });
        }

        function cleanup() {
            const plotIds = [
                'meanIntensityPlot', 
                'correlationPlot', 
                'missingHeatmapPlot', 
                'allColumnsDensityPlot', 
                'boxplotDistributionPlot'
            ];
            
            plotIds.forEach(id => {
                const plotDiv = document.getElementById(id);
                if (plotDiv) {
                    Plotly.purge(plotDiv);
                    plotDiv.innerHTML = ''; // Explicitly clear inner HTML
                }
            });

            if (window.summaryResizeHandlers) {
                window.summaryResizeHandlers.forEach(({ handler }) => {
                    window.removeEventListener('resize', handler);
                });
            }
            window.summaryResizeHandlers = [];
            
            $('#dist-select-all').off('click');
            $('#dist-unselect-all').off('click');
        }

        window.pageScriptRegistry = window.pageScriptRegistry || {};
        window.pageScriptRegistry.cleanup = cleanup;

        // Add event listener to reload plots
        document.body.addEventListener('plots-changed', function() {
            cleanup();
            init();
        });

        // Self-initialize
        init();
    })();
</script>


{% endblock %}
