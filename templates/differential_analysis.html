{% extends "base.html" %}

{% block title %}Differential Analysis - Metabolomic Data Analysis{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
{% endblock %}

{% block content %}
<style>
    #resultsTable {
        table-layout: fixed;
        width: 100%;
    }
    #resultsTable thead th {
        position: sticky;
        top: 0;
        z-index: 1;
        text-align: left;
    }
</style>
<div class="container-fluid">
    <!-- Flash Message Placeholder -->
    <div id="analysis-flash-messages"></div>

    <!-- Controls and Info -->
    <div class="row">
        <div class="col-lg-7">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Differential Analysis Controls</h5>
                </div>
                <div class="card-body">
                    <!-- Test Type Selection -->
                    <div class="mb-3">
                        <label for="testType" class="form-label"><b>Select Test Type:</b></label>
                        <select class="form-select" id="testType">
                            <optgroup label="Two-Group Parametric">
                                <option value="ttest">T-test (Independent)</option>
                                <option value="paired_ttest">T-test (Paired)</option>
                            </optgroup>
                            <optgroup label="Two-Group Non-Parametric">
                                <option value="wilcoxon">Wilcoxon Rank-Sum</option>
                            </optgroup>
                            <optgroup label="Multi-Group Parametric">
                                <option value="anova">ANOVA (with Tukey's HSD)</option>
                            </optgroup>
                            <optgroup label="Multi-Group Non-Parametric">
                                <option value="kruskal_wallis">Kruskal-Wallis</option>
                            </optgroup>
                            <optgroup label="Advanced Models">
                                <option value="linear_model">Linear Model (LM/GLM)</option>
                            </optgroup>
                        </select>
                    </div>

                    <!-- Group Selection -->
                    <div class="mb-3">
                        <label class="form-label"><b>Select Groups to Compare:</b></label>
                        <div id="groupsCheckboxes">
                            {% for group_id, group_name in group_names.items() %}
                                {% if group_id != '0' %}
                                    <div class="form-check">
                                        <input class="form-check-input group-checkbox" type="checkbox" value="{{ group_id }}" id="groupCheck{{ group_id }}">
                                        <label class="form-check-label" for="groupCheck{{ group_id }}">{{ group_name }}</label>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Paired T-test Options -->
                    <div id="pairedOptions" class="mb-3 p-3 border rounded bg-light" style="display: none;">
                        <h6>Paired Sample Mapping</h6>
                        <p class="text-muted small">Select which sample in the first group is paired with a sample in the second group.</p>
                        <div id="pairedMapContainer"></div>
                    </div>

                    <!-- Linear Model Options -->
                    <div id="lmOptions" class="mb-3 p-3 border rounded bg-light" style="display: none;">
                        <h6>Linear Model Formula</h6>
                        <input type="text" id="lmFormula" class="form-control" placeholder="e.g., value ~ group + batch">
                        <small class="form-text text-muted">Use 'value' as the response and 'group' as the main predictor. Add covariates from metadata (e.g., + batch_effect).</small>
                    </div>

                    <!-- Correction Method -->
                    <div class="mb-3">
                        <label for="correctionMethod" class="form-label"><b>Multiple Test Correction:</b></label>
                        <select class="form-select" id="correctionMethod">
                            <option value="fdr_bh">FDR (Benjamini-Hochberg)</option>
                            <option value="bonferroni">Bonferroni</option>
                            <option value="none">None</option>
                        </select>
                    </div>

                    <button type="button" id="runAnalysisBtn" class="btn btn-primary w-100 mt-3">
                        <i class="fas fa-play-circle me-2"></i>Run Analysis
                    </button>
                    <div class="progress mt-3" id="analysisProgress" style="display: none;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-5">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-globe me-2"></i>PERMANOVA</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <label for="distanceMetric" class="form-label"><b>Distance Metric:</b></label>
                            <select id="distanceMetric" class="form-select">
                                <option value="euclidean">Euclidean</option>
                                <option value="braycurtis">Bray-Curtis</option>
                                <option value="canberra">Canberra</option>
                                <option value="correlation">Correlation</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="permutations" class="form-label"><b>Permutations:</b></label>
                            <input type="number" id="permutations" class="form-control" value="999">
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="button" id="runPermanovaBtn" class="btn btn-secondary w-100">
                                <i class="fas fa-play-circle me-2"></i>Run PERMANOVA
                            </button>
                        </div>
                    </div>
                    <div id="permanovaProgress" class="progress mt-3" style="display: none;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-secondary" role="progressbar" style="width: 100%"></div>
                    </div>
                </div>
                <div class="card-footer" id="permanovaResultsContainer" style="display: none;">
                    <h6>PERMANOVA Results:</h6>
                    <div id="permanovaResults"></div>
                </div>
            </div>
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-ruler-combined me-2"></i>Latest Differential Analysis Applied</h5>
                </div>
                <div class="card-body">
                    <p class="mb-0">
                        {% if latest_differential_analysis_method %}
                            <strong>Method:</strong> {{ latest_differential_analysis_method }}
                        {% else %}
                            No Differential analysis has been applied yet (excluding PERMANOVA).
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>
    <!-- Results Table -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="m-0">Analysis Results</h5>
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-download me-2"></i>Export Data
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{{ url_for('export_dataframe', format='csv', context='differential_analysis_results') }}">Export as CSV</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('export_dataframe', format='tsv', context='differential_analysis_results') }}">Export as TSV</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('export_dataframe', format='excel', context='differential_analysis_results') }}">Export as Excel</a></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    <div id="resultsContainer" class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
                        {% if results_html %}
                            {{ results_html|safe }}
                        {% else %}
                            <p class="text-muted">Results will be displayed here.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function showFlash(message, category) {
    const flashDiv = $('#analysis-flash-messages');
    flashDiv.html(`<div class="alert alert-${category} alert-dismissible fade show">${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`);
}

function updatePairedOptions() {
    const groups = $('.group-checkbox:checked').map((_, el) => $(el).val()).get();
    const container = $('#pairedMapContainer');
    container.empty();

    if (groups.length !== 2) {
        container.html('<p class="text-danger">Please select exactly two groups for pairing.</p>');
        return;
    }

    // Fetch samples for each group
    const groupVector = {{ group_vector|tojson }};
    const groupNames = {{ group_names|tojson }};
    const group1Samples = Object.keys(groupVector).filter(s => groupVector[s].groups.includes(parseInt(groups[0])));
    const group2Samples = Object.keys(groupVector).filter(s => groupVector[s].groups.includes(parseInt(groups[1])));

    let mappingHtml = '<div class="row">';
    mappingHtml += `<div class="col-6"><h6>${groupNames[groups[0]]}</h6>`;
    group1Samples.forEach(s1 => {
        mappingHtml += `<div class="mb-2 d-flex align-items-center"><label class="me-2">${s1}</label><select class="form-select form-select-sm paired-selector" data-sample1="${s1}">`;
        mappingHtml += '<option value="">Select Pair</option>';
        group2Samples.forEach(s2 => {
            mappingHtml += `<option value="${s2}">${s2}</option>`;
        });
        mappingHtml += '</select></div>';
    });
    mappingHtml += '</div>';
    mappingHtml += `<div class="col-6"><h6>${groupNames[groups[1]]}</h6></div>`;
    mappingHtml += '</div>';
    container.html(mappingHtml);
}

$(document).ready(function() {
    // Toggle special option panels based on test type
    $('#testType').on('change', function() {
        const selectedTest = $(this).val();
        $('#pairedOptions').toggle(selectedTest === 'paired_ttest');
        $('#lmOptions').toggle(selectedTest === 'linear_model');
        if (selectedTest === 'paired_ttest') {
            updatePairedOptions();
        }
    }).trigger('change');

    // Update paired options when group selection changes
    $('.group-checkbox').on('change', function() {
        if ($('#testType').val() === 'paired_ttest') {
            updatePairedOptions();
        }
    });

    // Run Analysis button click
    $('#runAnalysisBtn').on('click', function() {
        const btn = $(this);
        const progress = $('#analysisProgress');
        
        const payload = {
            test_type: $('#testType').val(),
            groups: $('.group-checkbox:checked').map((_, el) => $(el).val()).get(),
            correction_method: $('#correctionMethod').val()
        };

        if (payload.test_type === 'paired_ttest') {
            payload.paired_map = [];
            $('.paired-selector').each(function() {
                const s1 = String($(this).data('sample1')); // Ensure sample1 is a string
                const s2 = String($(this).val()); // Ensure selected value is a string
                if (s1 && s2) {
                    payload.paired_map.push([s1, s2]);
                }
            });
            if (payload.paired_map.length === 0) {
                showFlash('Please map the paired samples before running the analysis.', 'warning');
                return;
            }
        }

        if (payload.test_type === 'linear_model') {
            payload.formula = $('#lmFormula').val();
            if (!payload.formula) {
                showFlash('Please provide a formula for the linear model.', 'warning');
                return;
            }
        }

        progress.show();
        btn.prop('disabled', true);
        $('#resultsContainer').html('<p class="text-muted">Running analysis...</p>');

        $.ajax({
            url: '{{ url_for("run_differential_analysis") }}',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function(response) {
                if (response.error) {
                    showFlash(response.error, 'danger');
                    $('#resultsContainer').html(`<p class="text-danger">${response.error}</p>`);
                } else {
                    showFlash('Analysis completed successfully!', 'success');
                    $('#resultsContainer').html(response.html);
                }
            },
            error: function(xhr) {
                const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : 'An unexpected error occurred.';
                showFlash(errorMsg, 'danger');
                $('#resultsContainer').html('<p class="text-danger">An error occurred.</p>');
            },
            complete: function() {
                progress.hide();
                btn.prop('disabled', false);
            }
        });
    });
    
    $('#runPermanovaBtn').on('click', function() {
        const btn = $(this);
        const progress = $('#permanovaProgress');
        const resultsContainer = $('#permanovaResultsContainer');
        const resultsDiv = $('#permanovaResults');

        const payload = {
            distance_metric: $('#distanceMetric').val(),
            permutations: $('#permutations').val()
        };

        progress.show();
        btn.prop('disabled', true);
        resultsContainer.hide();
        resultsDiv.html('');

        $.ajax({
            url: '{{ url_for("run_permanova_route") }}',
            method: 'POST',
            contentType: 'application/json', 
            data: JSON.stringify(payload),
            success: function(response) {
                if (response.error) {
                    showFlash(response.error, 'danger');
                } else {
                    showFlash('PERMANOVA completed successfully!', 'success');
                    resultsContainer.show();
                    resultsDiv.html(
                        `<ul class="list-unstyled">
                            <li><strong>Test Statistic:</strong> ${response.result.test_statistic.toFixed(4)}</li>
                            <li><strong>P-value:</strong> ${response.result.p_value.toFixed(4)}</li>
                        </ul>`
                    );
                }
            },
            error: function(xhr) {
                const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : 'An unexpected error occurred.';
                showFlash(errorMsg, 'danger');
            },
            complete: function() {
                progress.hide();
                btn.prop('disabled', false);
            }
        });
    });

    // Fix for ANOVA results not rendering correctly on page reload
    const resultsContainer = document.getElementById('resultsContainer');
    if (resultsContainer && resultsContainer.textContent.trim().startsWith('<ul class=\'list-unstyled mb-0\'>')) {
        // If the content is raw HTML (due to server-side escaping), re-render it as HTML
        resultsContainer.innerHTML = resultsContainer.textContent;
    }
});

</script>
{% endblock %}