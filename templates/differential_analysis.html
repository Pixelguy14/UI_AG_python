{% extends "base.html" %}

{% block title %}Differential Analysis - Metabolomic Data Analysis{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
{% endblock %}

{% block content %}
<style>
    #resultsTable {
        table-layout: fixed;
        width: 100%;
    }
    #resultsTable thead th {
        position: sticky;
        top: 0;
        z-index: 1;
        text-align: left;
    }
</style>
<div class="container-fluid fade-in">
    <!-- Flash Message Placeholder -->
    <div id="analysis-flash-messages"></div>

    <!-- Controls and Info -->
    <div class="row">
        <div class="col-lg-7">
            <div class="card animated-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Differential Analysis Controls</h5>
                </div>
                <div class="card-body">
                    <!-- Test Type Selection -->
                    <div class="mb-3">
                        <label for="testType" class="form-label"><b>Select Test Type:</b></label>
                        <select class="form-select" id="testType">
                            <optgroup label="Two-Group Parametric">
                                <option value="ttest">T-test (Independent)</option>
                                <option value="paired_ttest">T-test (Paired)</option>
                            </optgroup>
                            <optgroup label="Two-Group Non-Parametric">
                                <option value="mann_whitney">Mann-Whitney (Independent)</option>
                                <option value="paired_wilcoxon">Wilcoxon Rank-Sum (Paired)</option>
                            </optgroup>
                            <optgroup label="Multi-Group Parametric">
                                <option value="anova">ANOVA (Independent)</option>
                                <option value="anova_rm">ANOVA Repeated Measures (Paired)</option>
                            </optgroup>
                            <optgroup label="Multi-Group Non-Parametric">
                                <option value="kruskal_wallis">Kruskal-Wallis (Independent)</option>
                                <option value="friedman">Friedman (Paired)</option>
                            </optgroup>
                        </select>
                    </div>

                    <!-- ANOVA Post-hoc Selection -->
                    <div id="anovaPosthocOptions" class="mb-3" style="display: none;">
                        <label for="anovaPosthoc" class="form-label"><b>ANOVA Post-hoc Method:</b></label>
                        <select class="form-select" id="anovaPosthoc">
                            <option value="tukeyhsd">Tukey's HSD</option>
                            <option value="bonferroni">Bonferroni</option>
                            <option value="holm">Holm-Sidak</option>
                        </select>
                    </div>

                    <!-- Group Selection -->
                    <div class="mb-3">
                        <label class="form-label"><b>Select Groups to Compare:</b></label>
                        <div id="groupsCheckboxes">
                            {% for group_id, group_name in group_names.items() %}
                                {% if group_id != '0' %}
                                    <div class="form-check">
                                        <input class="form-check-input group-checkbox" type="checkbox" value="{{ group_id }}" id="groupCheck{{ group_id }}">
                                        <label class="form-check-label" for="groupCheck{{ group_id }}">{{ group_name }}</label>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Group Order Selection -->
                    <div id="groupOrderSelection" class="mb-3 p-3 border rounded bg-light" style="display: none;">
                        <h6>Comparison Order</h6>
                        <select id="comparisonOrderSelect" class="form-select"></select>
                    </div>

                    <!-- Paired Samples Button -->
                    <div id="pairedSamplesContainer" class="mb-3" style="display: none;">
                        <button type="button" id="definePairsBtn" class="btn btn-outline-secondary w-100">
                            <i class="fas fa-user-friends me-2"></i>Define Paired Samples
                        </button>
                    </div>

                    <!-- Correction Method -->
                    <div class="mb-3">
                        <label for="correctionMethod" class="form-label"><b>Multiple Test Correction:</b></label>
                        <select class="form-select" id="correctionMethod">
                            <option value="fdr_bh">FDR (Benjamini-Hochberg)</option>
                            <option value="bonferroni">Bonferroni</option>
                            <option value="none">None</option>
                        </select>
                    </div>

                    <button type="button" id="runAnalysisBtn" class="btn btn-primary w-100 mt-3 btn-enhanced pulse-on-hover">
                        <i class="fas fa-play-circle me-2"></i>Run Analysis
                    </button>
                    <div class="progress mt-3" id="analysisProgress" style="display: none;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                    </div>
                </div>
            </div>
            <!-- Normality Results Card -->
            <div class="card animated-card mt-3" id="normalityResultsCard" style="display: none;">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Normality Check</h5>
                </div>
                <div class="card-body">
                    <div id="normalityResultsContent"></div>
                    <p class="mt-3 mb-0" id="normalityRecommendation"></p>
                </div>
            </div>
        </div>
        <div class="col-lg-5">
            <div class="card animated-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-globe me-2"></i>PERMANOVA</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <label for="distanceMetric" class="form-label"><b>Distance Metric:</b></label>
                            <select id="distanceMetric" class="form-select">
                                <option value="euclidean">Euclidean</option>
                                <option value="braycurtis">Bray-Curtis</option>
                                <option value="canberra">Canberra</option>
                                <option value="correlation">Correlation</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="permutations" class="form-label"><b>Permutations:</b></label>
                            <input type="number" id="permutations" class="form-control" value="999">
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="button" id="runPermanovaBtn" class="btn btn-secondary w-100 btn-enhanced pulse-on-hover">
                                <i class="fas fa-play-circle me-2"></i>Run PERMANOVA
                            </button>
                        </div>
                    </div>
                    <div id="permanovaProgress" class="progress mt-3" style="display: none;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-secondary" role="progressbar" style="width: 100%"></div>
                    </div>
                </div>
                <div class="card-footer" id="permanovaResultsContainer" style="display: none;">
                    <h6>PERMANOVA Results:</h6>
                    <div id="permanovaResults"></div>
                </div>
            </div>
            <div class="card animated-card mt-4" id="dataStateCard" {% if not is_log_transformed and not is_scaled and not is_normalized %}style="display: none;"{% endif %}>
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-ruler-combined me-2"></i>Latest Differential Analysis Applied</h5>
                </div>
                <div class="card-body">
                    <p class="mb-0">
                        {% if latest_differential_analysis_method %}
                            <strong>Method:</strong> {{ latest_differential_analysis_method }}
                        {% else %}
                            No Differential analysis has been applied yet (excluding PERMANOVA).
                        {% endif %}
                    </p>
                    <hr>
                    <p class="mb-0">
                        <strong>Data State:</strong><br>
                        Log-Transformed: 
                        {% if is_log_transformed %}
                            <span class="badge bg-success">On</span>
                        {% else %}
                            <span class="badge bg-danger">Off</span>
                        {% endif %}<br>
                        Scaled: 
                        {% if is_scaled %}
                            <span class="badge bg-success">On</span>
                        {% else %}
                            <span class="badge bg-danger">Off</span>
                        {% endif %}<br>
                        Normalized: 
                        {% if is_normalized %}
                            <span class="badge bg-success">On</span>
                        {% else %}
                            <span class="badge bg-danger">Off</span>
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>

    

    <!-- Results Table -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card animated-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="m-0">Analysis Results</h5>
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary dropdown-toggle btn-enhanced pulse-on-hover" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-download me-2"></i>Export Data
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="downloadFile('{{ url_for('core.export_dataframe', format='csv', context='differential_analysis_results') }}', 'differential_analysis_results.csv')">Export as CSV</a></li>
                            <li><a class="dropdown-item" href="#" onclick="downloadFile('{{ url_for('core.export_dataframe', format='tsv', context='differential_analysis_results') }}', 'differential_analysis_results.tsv')">Export as TSV</a></li>
                            <li><a class="dropdown-item" href="#" onclick="downloadFile('{{ url_for('core.export_dataframe', format='excel', context='differential_analysis_results') }}', 'differential_analysis_results.xlsx')">Export as Excel</a></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    <div id="resultsContainer" class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
                        {% if results_html %}
                            {{ results_html|safe }}
                        {% else %}
                            <p class="text-muted">Results will be displayed here.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Pairing Modal -->
<div class="modal fade" id="pairingModal" tabindex="-1" aria-labelledby="pairingModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="pairingModalLabel">Define Paired Samples</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="pairingModalBody">
        <!-- Content will be dynamically inserted here -->
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    (function() {
        let pairedData = {{ paired_data|tojson }}; // Load from session

        function downloadFile(url, filename) {
            fetch(url)
                .then(response => response.blob())
                .then(blob => {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                })
                .catch(e => {
                    window.showToast('Download failed.', 'danger');
                });
        }
        window.downloadFile = downloadFile;

        function updateGroupOrderSelection() {
            const selectedTest = $('#testType').val();
            const twoGroupTests = ['ttest', 'paired_ttest', 'mann_whitney', 'paired_wilcoxon'];
            const isTwoGroupTest = twoGroupTests.includes(selectedTest);
            const selectedGroups = $('.group-checkbox:checked');
            const groupOrderContainer = $('#groupOrderSelection');
            const comparisonOrderSelect = $('#comparisonOrderSelect');

            if (isTwoGroupTest && selectedGroups.length === 2) {
                const group1 = {
                    id: $(selectedGroups[0]).val(),
                    name: $(selectedGroups[0]).next('label').text().trim()
                };
                const group2 = {
                    id: $(selectedGroups[1]).val(),
                    name: $(selectedGroups[1]).next('label').text().trim()
                };

                comparisonOrderSelect.empty();
                comparisonOrderSelect.append(`<option value="${group1.id}_${group2.id}">${group1.name} vs ${group2.name}</option>`);
                comparisonOrderSelect.append(`<option value="${group2.id}_${group1.id}">${group2.name} vs ${group1.name}</option>`);
                
                groupOrderContainer.show();
            } else {
                groupOrderContainer.hide();
                comparisonOrderSelect.empty();
            }
        }

        function updatePairedSamplesButtonVisibility() {
            const selectedTest = $('#testType').val();
            const isPairedTest = ['paired_ttest', 'paired_wilcoxon', 'anova_rm', 'friedman'].includes(selectedTest);
            const selectedGroupsCount = $('.group-checkbox:checked').length;
            $('#pairedSamplesContainer').toggle(isPairedTest && selectedGroupsCount >= 2);
        }

        function checkNormality() {
            const selectedGroups = $('.group-checkbox:checked').map((_, el) => $(el).val()).get();
            const normalityCard = $('#normalityResultsCard');
            const normalityContent = $('#normalityResultsContent');
            const normalityRecommendation = $('#normalityRecommendation');

            if (selectedGroups.length > 0) {
                normalityContent.html('<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Checking normality...</div>');
                normalityCard.show();

                $.ajax({
                    url: '{{ url_for("api.run_normality_check") }}',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ groups: selectedGroups }),
                    success: function(response) {
                        if (response.error) {
                            normalityContent.html(`<p class="text-danger">${response.error}</p>`);
                            normalityRecommendation.empty();
                        } else {
                            let resultsHtml = '<ul class="list-group list-group-flush">';
                            for (const [group, result] of Object.entries(response.results)) {
                                resultsHtml += `<li class="list-group-item d-flex justify-content-between align-items-center">${group}<span class="badge bg-light text-dark">${result}</span></li>`;
                            }
                            resultsHtml += '</ul>';
                            normalityContent.html(resultsHtml);
                            normalityRecommendation.text(response.recommendation);

                            if (response.warnings && response.warnings.length > 0) {
                                response.warnings.forEach(warning => {
                                    window.showToast(warning, 'warning');
                                });
                            }
                        }
                    },
                    error: function(xhr) {
                        const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : 'Failed to check normality.';
                        normalityContent.html(`<p class="text-danger">${errorMsg}</p>`);
                        normalityRecommendation.empty();
                        window.showToast(errorMsg, 'danger');
                    }
                });
            } else {
                normalityCard.hide();
                normalityContent.empty();
                normalityRecommendation.empty();
            }
        }

        function init() {
            // --- EVENT HANDLERS ---
            $('#testType').on('change.da', function() {
                const selectedTest = $(this).val();
                $('#anovaPosthocOptions').toggle(['anova', 'anova_rm'].includes(selectedTest));
                updateGroupOrderSelection();
                updatePairedSamplesButtonVisibility();
            }).trigger('change');

            $('.group-checkbox').on('change.da', function() {
                updateGroupOrderSelection();
                checkNormality();
                updatePairedSamplesButtonVisibility();
            });

            $('#definePairsBtn').on('click.da', function() {
                // Get selected groups
                const selectedGroups = $('.group-checkbox:checked').map((_, el) => $(el).val()).get();
                
                if (selectedGroups.length < 2) {
                    window.showToast('Please select at least two groups for a paired analysis.', 'warning');
                    return;
                }
                
                // Show loading state
                $('#pairingModalBody').html('<div class="text-center p-4"><i class="fas fa-spinner fa-spin me-2"></i>Loading pairing table...</div>');
                
                // Show the modal
                const modalEl = document.getElementById('pairingModal');
                const modalInstance = bootstrap.Modal.getOrCreateInstance(modalEl);
                modalInstance.show();
                
                // Make AJAX request to get pairing table
                $.ajax({
                    url: '/api/get_pairing_table',
                    method: 'GET',
                    data: { groups: selectedGroups },
                    success: function(response) {
                        $('#pairingModalBody').html(response);
                        
                        // Add event listener for form submission
                        $('#pairingForm').on('submit', function(e) {
                            e.preventDefault();
                            
                            // Collect form data
                            const formData = new FormData();
                            const paired_map = [];
                            
                            document.querySelectorAll('#pairedSamplesTable tbody tr').forEach(tr => {
                                const row = [tr.cells[0].innerText.trim()];
                                tr.querySelectorAll('select').forEach(select => {
                                    row.push(select.value);
                                });
                                paired_map.push(row);
                            });
                            
                            formData.append('paired_map', JSON.stringify(paired_map));
                            formData.append('groups', JSON.stringify(selectedGroups));
                            
                            // Submit via AJAX
                            $.ajax({
                                url: '/api/save_pairing_data',
                                method: 'POST',
                                data: formData,
                                processData: false,
                                contentType: false,
                                success: function() {
                                    window.showToast('Pairing data saved successfully!', 'success');
                                    modalInstance.hide();
                                },
                                error: function(xhr) {
                                    const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : 'Failed to save pairing data.';
                                    window.showToast(errorMsg, 'danger');
                                }
                            });
                        });
                    },
                    error: function(xhr) {
                        const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : 'Failed to load pairing table.';
                        $('#pairingModalBody').html(`<div class="alert alert-danger">${errorMsg}</div>`);
                    }
                });
            });

            $('#runPermanovaBtn').on('click.da', function() {
                const btn = $(this);
                const progress = $('#permanovaProgress');
                const resultsContainer = $('#permanovaResultsContainer');
                const resultsDiv = $('#permanovaResults');

                const payload = {
                    distance_metric: $('#distanceMetric').val(),
                    permutations: $('#permutations').val()
                };

                progress.show();
                btn.prop('disabled', true);
                resultsContainer.hide();

                $.ajax({
                    url: '{{ url_for("api.run_permanova_route") }}',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(payload),
                    success: function(response) {
                        if (response.error) {
                            window.showToast(response.error, 'danger');
                        } else {
                            window.showToast('PERMANOVA completed successfully!', 'success');
                            resultsDiv.html(`
                                <p class="mb-1"><strong>F-statistic:</strong> ${response.result.test_statistic.toFixed(4)}</p>
                                <p class="mb-0"><strong>p-value:</strong> ${response.result.p_value.toFixed(4)}</p>
                            `);
                            resultsContainer.show();
                        }
                    },
                    error: function(xhr) {
                        const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : 'An unexpected error occurred.';
                        window.showToast(errorMsg, 'danger');
                    },
                    complete: function() {
                        progress.hide();
                        btn.prop('disabled', false);
                    }
                });
            });

            $('#runAnalysisBtn').on('click.da', function() {
                const btn = $(this);
                const progress = $('#analysisProgress');
                
                const payload = {
                    test_type: $('#testType').val(),
                    groups: $('.group-checkbox:checked').map((_, el) => $(el).val()).get(),
                    correction_method: $('#correctionMethod').val()
                };

                if ($('#anovaPosthocOptions').is(':visible')) {
                    payload.posthoc_method = $('#anovaPosthoc').val();
                }

                if ($('#groupOrderSelection').is(':visible')) {
                    const selectedOrder = $('#comparisonOrderSelect').val();
                    const parts = selectedOrder.split('_');
                    payload.reference_group_id = parts[0];
                    payload.comparison_group_id = parts[1];
                }

                progress.show();
                btn.prop('disabled', true);
                $('#resultsContainer').html('<p class="text-muted">Running analysis...</p>');

                $.ajax({
                    url: '{{ url_for("api.run_differential_analysis") }}',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(payload),
                    success: function(response) {
                        if (response.error) {
                            window.showToast(response.error, 'danger');
                            $('#resultsContainer').html(`<p class="text-danger">${response.error}</p>`);
                        } else {
                            window.showToast('Analysis completed successfully!', 'success');
                            $('#resultsContainer').html(response.html);

                            if (response.significant_count !== undefined) {
                                const message = `Found ${response.significant_count} significant features.`;
                                window.showToast(message, 'info', 6000);
                            }

                            if (response.warnings && response.warnings.length > 0) {
                                response.warnings.forEach(warning => {
                                    window.showToast(warning, 'warning');
                                });
                            }
                        if (response.warnings && response.warnings.length > 0) {
                                response.warnings.forEach(warning => {
                                    window.showToast(warning, 'warning');
                                });
                            }
                        }
                    },
                    error: function(xhr) {
                        const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : 'An unexpected error occurred.';
                        window.showToast(errorMsg, 'danger');
                        $('#resultsContainer').html('<p class="text-danger">An error occurred.</p>');
                    },
                    complete: function() {
                        progress.hide();
                        btn.prop('disabled', false);
                    }
                });
            });
        }

        function cleanup() {
            $('#testType, .group-checkbox, #runAnalysisBtn, #definePairsBtn, #runPermanovaBtn').off('.da');
            
            const modalEl = document.getElementById('pairingModal');
            if (modalEl) {
                const modalInstance = bootstrap.Modal.getInstance(modalEl);
                if (modalInstance) {
                    modalInstance.dispose();
                }
            }
        }
        if (window.pageScriptRegistry) {
            window.pageScriptRegistry.cleanup = cleanup;
        }

        $(document).ready(function() {
            init();
        });
    })();
</script>
{% endblock %}
