{% extends "base.html" %}

{% block title %}Result Visualization{% endblock %}

{% block content %}
<div class="container-fluid fade-in">
    <div class="row">
        <div class="col-12">
            <div class="card animated-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-fire me-2"></i>Volcano Plot</h5>
                    <button class="btn btn-secondary btn-sm" onclick="exportPlotAsSVG_RCT('volcanoPlot', 'volcano_plot')">
                        <i class="fas fa-download me-2"></i>Export as SVG
                    </button>
                </div>
                <div class="card-body">
                    <div id="volcanoPlot"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="row mt-4">
        <div class="col-12">
            <div class="card animated-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-th me-2"></i>Clustergram</h5>
                    <button class="btn btn-secondary btn-sm" onclick="exportPlotAsSVG_SQR('clustergramPlot', 'clustergram')">
                        <i class="fas fa-download me-2"></i>Export as SVG
                    </button>
                </div>
                <div class="card-body">
                    <div class="row align-items-end">
                        <div class="col-md-4">
                            <label for="topNFeatures" class="form-label"><b>Top N Features:</b></label>
                            <input type="number" id="topNFeatures" class="form-control" value="50" min="2" max="{{ max_features }}">
                        </div>
                        <div class="col-md-4">
                            <label for="distanceMetric" class="form-label"><b>Distance Metric:</b></label>
                            <select id="distanceMetric" class="form-select">
                                <option value="euclidean">Euclidean</option>
                                <option value="braycurtis">Bray-Curtis</option>
                                <option value="canberra">Canberra</option>
                                <option value="correlation">Correlation</option>
                                <option value="cityblock">Manhattan</option>
                                <option value="chebyshev">Chebyshev</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="linkageMethod" class="form-label"><b>Linkage Method:</b></label>
                            <select id="linkageMethod" class="form-select">
                                <option value="average">Average</option>
                                <option value="single">Single</option>
                                <option value="complete">Complete</option>
                                <option value="ward">Ward</option>
                            </select>
                        </div>
                    </div>
                    <div class="row align-items-end mt-3">
                        <div class="col-md-6">
                            <label for="colorPalette" class="form-label"><b>Color Palette:</b></label>
                            <select id="colorPalette" class="form-select">
                                <option value="RdBu">Red-Blue</option>
                                <option value="Viridis">Viridis</option>
                                <option value="YlGnBu">Yellow-Green-Blue</option>
                                <option value="Cividis">Cividis</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="yAxisLabel" class="form-label"><b>Y-Axis Label:</b></label>
                            <select id="yAxisLabel" class="form-select">
                                <option value="">Feature ID</option> <!-- Default option -->
                                {% for col in metadata_columns %}
                                <option value="{{ col }}">{{ col }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 mt-3">
                            <button type="button" id="updateClustergramBtn" class="btn btn-primary w-100 btn-enhanced pulse-on-hover">
                                <i class="fas fa-sync-alt me-2"></i>Update Clustergram
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="clustergramPlot"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    (function() {

        function init() {
            function loadScript(src, callback) {
                const existingScript = document.querySelector(`script[src="${src}"]`);
                if (existingScript && existingScript.dataset.loaded === 'true') {
                    if (callback) callback();
                    return;
                }
                if (existingScript) {
                    existingScript.addEventListener('load', () => { if (callback) callback(); });
                    return;
                }
                const script = document.createElement('script');
                script.src = src;
                script.dataset.loaded = 'false';
                script.onload = () => {
                    script.dataset.loaded = 'true';
                    if (callback) callback();
                };
                document.head.appendChild(script);
            }

            function initPageScripts() {
                const volcanoPlotDiv = document.getElementById('volcanoPlot');
                if (volcanoPlotDiv) {
                    const plotData = {{ volcano_plot_json|safe }};
                    Plotly.newPlot('volcanoPlot', plotData.data, plotData.layout, {responsive: true});
                }
                const clustergramDiv = document.getElementById('clustergramPlot');
                if (clustergramDiv) {
                    initClustergramPage();
                }
            }

            loadScript("{{ url_for('static', filename='js/export.js') }}", function() {
                loadScript("{{ url_for('static', filename='js/plots.js') }}", function() {
                    setTimeout(initPageScripts, 50);
                });
            });
        }

        function cleanup() {
            if (typeof cleanupClustergramPage === 'function') {
                cleanupClustergramPage();
            }
        }

        // Register the cleanup function with the global dispatcher
        window.pageScriptRegistry.cleanup = cleanup;

        // Self-initialize
        init();
    })();
</script>
{% endblock %}
