{% extends "base.html" %}

{% block title %}Multivariate Analysis - Metabolomic Data Analysis{% endblock %}

{% block content %}
<div class="container-fluid fade-in">
    <!-- Comparison Plots -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card animated-card">
                <div class="card-body">
                    <div class="row align-items-end">
                        <div class="col-md-4">
                            <label for="plotSelector1" class="form-label"><b>Select Plot 1:</b></label>
                            <select id="plotSelector1" class="form-select">
                                {% for index, message in history_options %}
                                    <option value="{{ index }}">{{ message }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="plotSelector2" class="form-label"><b>Select Plot 2:</b></label>
                            <select id="plotSelector2" class="form-select">
                                {% for index, message in history_options %}
                                    <option value="{{ index }}" {% if index == selected_history_index %}selected{% endif %}>{{ message }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="plotType" class="form-label"><b>Plot Type:</b></label>
                            <select id="plotType" class="form-select">
                                <option value="pca">PCA</option>
                                <option value="plsda">PLS-DA</option>
                                <option value="oplsda">OPLS-DA</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary w-100 btn-enhanced pulse-on-hover" onclick="loadPlots()">Compare</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card animated-card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0" id="plotTitle1">Plot 1</h5>
                    <button class="btn btn-secondary btn-sm btn-enhanced pulse-on-hover" onclick="exportPlotAsSVG_SQR('plotContainer1', 'multivariate_plot_1')">
                        <i class="fas fa-download me-2"></i>Export as SVG
                    </button>
                </div>
                <div class="card-body"><div id="plotContainer1" style="min-height: 500px;"></div></div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="card animated-card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0" id="plotTitle2">Plot 2</h5>
                    <button class="btn btn-secondary btn-sm btn-enhanced pulse-on-hover" onclick="exportPlotAsSVG_SQR('plotContainer2', 'multivariate_plot_2')">
                        <i class="fas fa-download me-2"></i>Export as SVG
                    </button>
                </div>
                <div class="card-body"><div id="plotContainer2" style="min-height: 500px;"></div></div>
            </div>
        </div>
    </div>

    <!-- Analysis Section -->
    <div class="row">
        <!-- HCA -->
        <div class="col-lg mb-4">
            <div class="card animated-card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Hierarchical Clustering Analysis (HCA)</h5>
                    <button class="btn btn-secondary btn-sm btn-enhanced pulse-on-hover" onclick="exportPlotAsSVG_RCT_2('hcaPlotContainer', 'hca_plot')">
                        <i class="fas fa-download me-2"></i>Export as SVG
                    </button>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Distance Metric</h6>
                            <div class="form-check"><input class="form-check-input" type="radio" name="distance_metric" id="euclidean" value="euclidean" checked><label class="form-check-label" for="euclidean">Euclidean</label></div>
                            <div class="form-check"><input class="form-check-input" type="radio" name="distance_metric" id="cityblock" value="cityblock"><label class="form-check-label" for="cityblock">Manhattan</label></div>
                            <div class="form-check"><input class="form-check-input" type="radio" name="distance_metric" id="chebyshev" value="chebyshev"><label class="form-check-label" for="chebyshev">Maximum</label></div>
                        </div>
                        <div class="col-md-6">
                            <h6>Linkage Method</h6>
                            <div class="form-check"><input class="form-check-input" type="radio" name="linkage_method" id="average" value="average" checked><label class="form-check-label" for="average">Average</label></div>
                            <div class="form-check"><input class="form-check-input" type="radio" name="linkage_method" id="single" value="single"><label class="form-check-label" for="single">Single</label></div>
                            <div class="form-check"><input class="form-check-input" type="radio" name="linkage_method" id="complete" value="complete"><label class="form-check-label" for="complete">Complete</label></div>
                        </div>
                    </div>
                    <div id="hcaPlotContainer" style="width: 100%; height: 600px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/export.js') }}"></script>
<script>
    (function() {
        function fetchAndRenderPlot(historyIndex, containerId, plotType) {
            let url;
            if (plotType === 'pca') url = `{{ url_for("api.get_pca_plot", history_index=0) }}`.replace('/0', '/' + historyIndex);
            else if (plotType === 'plsda') url = `{{ url_for("api.get_plsda_plot", history_index=0) }}`.replace('/0', '/' + historyIndex);
            else if (plotType === 'oplsda') url = `{{ url_for("api.get_oplsda_plot", history_index=0) }}`.replace('/0', '/' + historyIndex);

            const container = $(`#${containerId}`);
            container.html('<div class="skeleton" style="height: 500px; width: 100%;"></div>'); // Skeleton loader

            $.ajax({
                url: url,
                method: 'GET',
                success: function(response) {
                    if (response.plot) {
                        const plotData = JSON.parse(response.plot);
                        Plotly.newPlot(containerId, plotData.data, plotData.layout, { responsive: true });
                    } else {
                        window.showToast('Plot not available for this processing step.', 'warning');
                        container.html('<div class="text-center text-muted py-5"><i class="fas fa-chart-bar fa-2x mb-2"></i><p>Plot not available.</p></div>');
                    }
                },
                error: () => {
                    window.showToast('Error loading plot.', 'danger');
                    container.html('<div class="text-center text-muted py-5"><i class="fas fa-exclamation-triangle fa-2x mb-2"></i><p>Error loading plot.</p></div>');
                }
            });
        }

        function fetchAndRenderHca() {
            const payload = {
                distance_metric: $('input[name="distance_metric"]:checked').val(),
                linkage_method: $('input[name="linkage_method"]:checked').val()
            };
            const container = $('#hcaPlotContainer');
            container.html('<div class="skeleton" style="height: 600px; width: 100%;"></div>'); // Skeleton loader

            $.ajax({
                url: '{{ url_for("api.get_hca_plot") }}',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function(response) {
                    if (response.plot) {
                        container.html(''); // Clear skeleton
                        const plotData = JSON.parse(response.plot);
                        Plotly.newPlot('hcaPlotContainer', plotData.data, plotData.layout, { responsive: true });
                    } else {
                        window.showToast('HCA plot not available.', 'warning');
                        container.html('<div class="text-center text-muted py-5"><i class="fas fa-chart-bar fa-2x mb-2"></i><p>HCA plot not available.</p></div>');
                    }
                },
                error: () => {
                    window.showToast('Error loading HCA plot.', 'danger');
                    container.html('<div class="text-center text-muted py-5"><i class="fas fa-exclamation-triangle fa-2x mb-2"></i><p>Error loading HCA plot.</p></div>');
                }
            });
        }

        window.loadPlots = function() {
            let index1 = parseInt($('#plotSelector1').val());
            let index2 = parseInt($('#plotSelector2').val());
            const plotType = $('#plotType').val();

            if (isNaN(index1) || isNaN(index2)) {
                window.showToast('Please select valid processing steps for comparison.', 'warning');
                return;
            }

            $('#plotTitle1').text($('#plotSelector1 option:selected').text() + ' - ' + plotType.toUpperCase());
            $('#plotTitle2').text($('#plotSelector2 option:selected').text() + ' - ' + plotType.toUpperCase());

            fetchAndRenderPlot(index1, 'plotContainer1', plotType);
            fetchAndRenderPlot(index2, 'plotContainer2', plotType);
            fetchAndRenderHca();
        }

        function init() {
            loadPlots();
            $('input[name="distance_metric"], input[name="linkage_method"]').on('change.mva', fetchAndRenderHca);
        }

        function cleanup() {
            $('input[name="distance_metric"], input[name="linkage_method"]').off('.mva');
            const plotIds = ['plotContainer1', 'plotContainer2', 'hcaPlotContainer'];
            plotIds.forEach(id => {
                const plotDiv = document.getElementById(id);
                if (plotDiv && plotDiv.innerHTML) {
                    Plotly.purge(plotDiv);
                }
            });
        }

        if (window.pageScriptRegistry) {
            window.pageScriptRegistry.cleanup = cleanup;
        }

        $(document).ready(init);
    })();
</script>
{% endblock %}